---
title: "Figure_4"
author: "Clay Carey"
date: "2025-01-29"
output: html_document
---

```{r setup}
knitr::opts_knit$set(root.dir = "/Users/claytoncarey/Documents/Seurat/micdrop_seq/micdrop/Figure_code/Code_for_submission/MIC-Drop-seq")
```

Import required packages
```{r message=FALSE, warning=FALSE}
library(Seurat)
library(tidyverse)
library(igraph)
library(ComplexHeatmap)
library(viridis)
library(scCustomize)
library(EnhancedVolcano)
library(ggpubr)
library(ggrepel)

library(rstatix)
library(DescTools)
```

# =============================================================================
# DATA IMPORT
# =============================================================================

Import daniocell data and lineage codes
```{r}
## dcell_lineage: maps each daniocell cell type to abbreviated lineage codes
## dcell: daniocell reference dataset (Lange et al.)
## combined.meta: metadata with curated lineage sequences for each cell type
dcell_lineage <- read_csv(file = "input_data/dcell_lineage_codes.csv")
dcell <- readRDS(file = "input_data/dcell_3_24.rds")
combined.meta <- readRDS(file = "input_data/lineagemeta.rds")

head(dcell_lineage)


```

Trim excess data from daniocell, keeping only expression of micdrop-seq target genes
```{r}
## DietSeurat removes all gene expression data except for CRISPR target genes
## This reduces memory footprint for downstream analysis
dcell <- DietSeurat(dcell, features = unique(combined.meta$class))

## Add lineage identifiers to metadata by matching on full_ident column
dcell@meta.data <- dcell@meta.data %>% 
  left_join(dcell_lineage, by = "full_ident")

rownames(dcell@meta.data) <- dcell@meta.data$CELL
```

# =============================================================================
# EXPRESSION ANALYSIS - DANIOCELL
# =============================================================================

Calculate average expression for each target gene in each lineage, scale to 0-1 range
```{r}
## Get mean expression of each CRISPR target gene across all cells in each lineage
dcell_target_exp <- AverageExpression(dcell, 
                                       group.by = "lineage_ident", 
                                       features = unique(combined.meta$class))

dcell_target_exp <- data.frame(dcell_target_exp, check.names = FALSE)
names(dcell_target_exp) <- gsub("RNA.", "", names(dcell_target_exp))

## Min-max scaling to normalize expression values between 0-1 for each gene
## This allows comparison across genes with different expression ranges
range01 <- function(x) {(x - min(x)) / (max(x) - min(x))}

## Convert to long format and apply scaling within each perturbation group
dcell_target_scaled <- dcell_target_exp %>% 
  rownames_to_column(var = "perturbation") %>%
  pivot_longer(cols = -perturbation, names_to = "lineage", values_to = "expression") %>%
  group_by(perturbation) %>%
  mutate(scaled_expression = range01(expression))
  
head(dcell_target_scaled)
```

Add viridis color palette for scaled expression values
```{r}
## Create lookup table mapping scaled values (0-100) to viridis colors
## Used for coloring nodes in the lineage network plot
color_key <- data.frame(
  color = viridis(101, option = "D"), 
  color_value = 0:100
)

## Round scaled expression to integer and merge with color palette
dcell_target_scaled <- dcell_target_scaled %>% 
  mutate(color_value = round(scaled_expression * 100)) %>%
  left_join(color_key, by = "color_value")

dcell_target_scaled
```

# =============================================================================
# LINEAGE NETWORK PLOTTING
# =============================================================================

Load igraph coordinates and community colors
```{r}
## coords: precomputed node positions for consistent network layout
## community_colors: color assignments for each developmental compartment
coords <- readRDS(file = "input_data/coords_layout.rds")
community_colors <- read.csv(file = "input_data/community_colors.csv", header = TRUE) %>%
  mutate(color_trans = paste0(color, 30))  ## add alpha transparency
```

Function to plot lineage network 
```{r, fig.height=15, fig.width=15}
#' Plot developmental lineage network with gene expression overlay
#' @param gene Target gene name to color nodes by expression
#' @param celltype Target cell type for shortest path highlighting
plot_network <- function(gene, celltype) {
  
  ## Load network structure from edge/node lists
  links <- read.csv(file = "input_data/links_full.csv", header = TRUE)
  nodes <- read.csv(file = "input_data/nodes_full2.csv")
  
  ## Build directed graph from edge list
  tmp_net <- graph_from_data_frame(d = links, vertices = nodes, directed = TRUE)
  
  ## Extract colors for this gene, ordered to match network vertices
  colrs <- dcell_target_scaled %>% 
    filter(perturbation == gene) %>%
    mutate(lineage = factor(lineage, levels = names(V(tmp_net)))) %>%
    arrange(lineage) %>%
    pull(color)
  
  V(tmp_net)$color <- colrs[V(tmp_net)]
  
  ## Compute shortest path from blastula to target cell type
  ## Used to visualize the developmental trajectory
  lineage.path <- shortest_paths(
    tmp_net, 
    from = V(tmp_net)[cell_type == "Blastula"], 
    to = V(tmp_net)[cell_type == celltype],
    output = "both"
  )
  
  ## Highlight edges along the shortest path in orange
  ecol <- rep("gray20", ecount(tmp_net))
  ecol[unlist(lineage.path$epath)] <- "orange"
  
  ew <- rep(2, ecount(tmp_net))
  ew[unlist(lineage.path$epath)] <- 4
  
  ## Use edge betweenness clustering but override with manual cell_group assignments
  ## This creates the shaded background regions for each compartment
  ceb <- cluster_edge_betweenness(tmp_net)
  ceb$membership <- V(tmp_net)$cell_group
  
  ## Render network plot
  plot(ceb, tmp_net, 
       col = "lightblue",
       edge.arrow.size = 0,
       vertex.label = V(tmp_net)$cell_type, 
       layout = coords,
       vertex.size = 7,
       edge.width = ew,
       edge.color = ecol,
       mark.border = "black",
       mark.alpha = 0.5,
       mark.col = community_colors$color_trans,
       vertex.label.cex = 1.3,
       vertex.label.color = "grey10",
       vertex.label.bgcolor = "white",
       vertex.label.fontface = "bold")
}

plot_network(gene = "tbxta", celltype = "Blastula")
```

# =============================================================================
# MICDROP-SEQ DATA PROCESSING
# =============================================================================

Load micdrop-seq dataset and define lineage paths
```{r}
micdrop <- readRDS(file = 'input_data/micdrop_2-6-25.rds')
micdrop@meta.data <- micdrop@meta.data %>% 
  select(-starts_with("prediction"))  ## remove label transfer predictions

meta <- micdrop@meta.data

## Define lineage path abbreviations
## Each string represents the developmental trajectory from blastula (BLS) to a progenitor state
## Format: most differentiated -> ... -> blastula
## e.g., HB = Hindbrain -> Neural Progenitors -> Neuroectoderm -> Blastula Neuron -> Blastula
PD <- "_PD_BN_BLS"
HB <- "_HB_NP_NE_BN_BLS"
NC <- "_NC_NP_NE_BN_BLS"
DEL <- "_DEL_NP-L_NP_NE_BN_BLS"
TEL <- "_TEL_NP-L_NP_NE_BN_BLS"
OP <- "_OP_NP-L_NP_NE_BN_BLS"
MB_P <- "_NP-L_NP_NE_BN_BLS"
IO <- "_IO_NNE_BN_BLS"
PE <- "_PE_NNE_BN_BLS"
NNE <- "_NNE_BN_BLS"
EN <- "_EN_BNN_BLS"
SC <- "_SC_BNN_BLS"
HMB <- "_HMB_BVL_BNN_BLS"
MYT <- "_MYT_PRX_PSM_BVL_BNN_BLS"
PRX <- "_PRX_RSM_BVL_BNN_BLS"
MS_P <- "_BVL_BNN_BLS"
BDM <- "_BDM_BNN_BLS"
GC <- "_GC_BNN_BLS"
SCL <- "_SCL_PRX_PSM_BVL_BNN_BLS"
BVL <- "_BVL_BNN_BLS"
PSM <- "_PSM_BVL_BNN_BLS"
HM <- "_HM_BVL_BNN_BLS"

## Map each MIC-Drop cell type to its full lineage path
## The lineage_code column stores the complete trajectory from cell type back to blastula
meta <- meta %>% mutate(lineage_code = case_when(
  ## Mesoderm / Vasculature
  curated_cell_type2 == "Vasculature - Veins" ~ paste0("VS-V", HM),
  curated_cell_type2 == "Hemangioblasts" ~ paste0(HMB),
  curated_cell_type2 == "Sclerotome - Chondrogenic" ~ paste0("SCL-C", SCL),
  curated_cell_type2 == "Hatching Gland" ~ paste0("HG", BDM),
  curated_cell_type2 == "Pronephros" ~ paste0("PRN", BVL),
  curated_cell_type2 == "Myotome" ~ paste0(MYT),
  curated_cell_type2 == "Somites - Late" ~ paste0("SOM-L_SOM-M_SOM-E", MYT),
  curated_cell_type2 == "Macrophages" ~ paste0("LC-M", HMB),
  curated_cell_type2 == "Sclerotome" ~ paste0(SCL),
  curated_cell_type2 == "Gut Primordia" ~ paste0("EN-G", EN),
  curated_cell_type2 == "Somites - Early" ~ paste0("SOM-E", MYT),
  curated_cell_type2 == "Mesenchyme - Progenitors" ~ paste0("MS-P", MS_P),
  curated_cell_type2 == "Erythroblasts" ~ paste0("ERB", HMB),
  curated_cell_type2 == "Mesenchyme - Pharyngeal Arches" ~ paste0("MS-PA", MS_P),
  curated_cell_type2 == "Cardiac Muscle" ~ paste0("HM-M", HM),
  curated_cell_type2 == "Vasculature - Arteries" ~ paste0("VS-A", HMB),
  curated_cell_type2 == "Slow Muscle" ~ paste0("SOM-S", MYT),
  curated_cell_type2 == "Presomitic Mesoderm" ~ paste0(PSM),
  curated_cell_type2 == "Mesenchyme - Cardiac" ~ paste0(HM),
  curated_cell_type2 == "Neutrophils" ~ paste0("LC-N", HMB),
  curated_cell_type2 == "Mesenchyme - Head" ~ paste0("MS-H", MS_P),
  curated_cell_type2 == "Somites - Mid" ~ paste0("SOM-M_SOM-E", MYT),
  curated_cell_type2 == "Notochord" ~ paste0("NCD", BDM),
  curated_cell_type2 == "Liver Primordia" ~ paste0("EN-P", EN),
  curated_cell_type2 == "Mesenchyme - Meninges Precursors" ~ paste0("MS-M", MS_P),
  
  ## Non-neural ectoderm / Neural crest
  curated_cell_type2 == "Otic Placode" ~ paste0("PE-OT", PE),
  curated_cell_type2 == "Pigment Cell Precursors" ~ paste0(NC),
  curated_cell_type2 == "Periderm" ~ paste0(PD),
  curated_cell_type2 == "Lateral Line Primordium" ~ paste0("EP-LL", PE),
  curated_cell_type2 == "Epidermis - Midbody" ~ paste0("EP-M", NNE),
  curated_cell_type2 == "Placodal Ectoderm" ~ paste0(PE),
  curated_cell_type2 == "Epidermis - Anterior" ~ paste0("EP-A", NNE),
  curated_cell_type2 == "Melanoblasts" ~ paste0("NC-M", NC),
  curated_cell_type2 == "Epidermis - Posterior Early" ~ paste0("EP-PE", NNE),
  curated_cell_type2 == "Ionocyte - K+ secreting" ~ paste0("IO-K", IO),
  curated_cell_type2 == "Ionocytes - H+" ~ paste0("IO-H", IO),
  curated_cell_type2 == "Lens Epithelium" ~ paste0("EP-L", PE),
  curated_cell_type2 == "Xanthoblasts" ~ paste0("NC-X", NC),
  curated_cell_type2 == "Epidermis - Pharyngeal pouch" ~ paste0("EP-PP", NNE),
  curated_cell_type2 == "Iridophores" ~ paste0("NC-I", NC),
  curated_cell_type2 == "Epidermis - Posterior Late" ~ paste0("EP-PL", NNE),
  curated_cell_type2 == "Gill Neurons" ~ paste0("NC-GL", NC),
  curated_cell_type2 == "Olfactory epithelium" ~ paste0("PE-OFE", PE),
  curated_cell_type2 == "Olfactory Goblet" ~ paste0("PE-OFG", PE),
  curated_cell_type2 == "Olfactory Neurons" ~ paste0("PE-OFN", PE),
  curated_cell_type2 == "Ionocyte Progenitors" ~ paste0(IO),
  curated_cell_type2 == "Mucus Secreting" ~ paste0("MUC", NNE),
  curated_cell_type2 == "Ionocytes - Na+" ~ paste0("IO-N", IO),
  
  ## Neural - Hindbrain / Spinal Cord
  curated_cell_type2 == "Hindbrain - Rhombic Lip" ~ paste0("HB-L", HB),
  curated_cell_type2 == "Hindbrain - Rhombomeres" ~ paste0("HB-R", HB),
  curated_cell_type2 == "Retina - Progenitors" ~ paste0("RET", OP),
  curated_cell_type2 == "Hindbrain - Committed" ~ paste0("HB-C_HB-R", HB),
  curated_cell_type2 == "Telencephalon" ~ paste0(TEL),
  curated_cell_type2 == "Diencephalon" ~ paste0(DEL),
  curated_cell_type2 == "Midbrain / Hindbrain Boundary" ~ paste0("HB-B", HB),
  curated_cell_type2 == "Diencephalon - Ventral" ~ paste0("DEL-V", DEL),
  curated_cell_type2 == "Spinal Cord - Proliferative" ~ paste0(SC),
  curated_cell_type2 == "Spinal Cord - Hindbrain Motor Neurons" ~ paste0("SC-HM", SC),
  curated_cell_type2 == "Spinal Cord - Lateral Floor Plate" ~ paste0("SC-FL", SC),
  curated_cell_type2 == "Telencephalon - Pallium" ~ paste0("TEL-P", TEL),
  curated_cell_type2 == "Spinal Cord - CSF-contacting neurons" ~ paste0("SC-K", SC),
  curated_cell_type2 == "Diencephalon - Dorsal" ~ paste0("DEL-D", DEL),
  curated_cell_type2 == "Retina - RPE" ~ paste0("RPE", OP),
  curated_cell_type2 == "Spinal Cord - Oligodendrocyte" ~ paste0("SC-OL", SC),
  curated_cell_type2 == "Midbrain" ~ paste0("MB", MB_P),
  curated_cell_type2 == "Hindbrain - Subventricular Zone" ~ paste0("HB-SV", HB),
  curated_cell_type2 == "Midbrain - Optic Tectum" ~ paste0("OT", MB_P),
  curated_cell_type2 == "Diencephalon - Tuberculum" ~ paste0("DEL-T", DEL),
  curated_cell_type2 == "Spinal Cord - Cholinergic Motor Neurons" ~ paste0("SC-CM", SC),
  curated_cell_type2 == "Cranial Ganglia" ~ paste0("NC-C", NC),
  curated_cell_type2 == "Spinal Cord - Radial Glia" ~ paste0("SC-GL", SC),
  curated_cell_type2 == "Diencephalon - Hypothalamus / POA" ~ paste0("DEL-H", DEL),
  curated_cell_type2 == "Midbrain - Dorsal" ~ paste0("MB-D", MB_P),
  curated_cell_type2 == "Spinal Cord - Medial Floorplate" ~ paste0("SC-FM", SC),
  TRUE ~ "FIX"
))
```

# =============================================================================
# EXPRESSION ANALYSIS - MICDROP
# =============================================================================

Calculate scaled expression of target genes in micdrop cell types
```{r}
## Same approach as daniocell: get average expression, then min-max scale per gene
micdrop_target_exp <- AverageExpression(micdrop, 
                                         group.by = "curated_cell_type2", 
                                         features = unique(combined.meta$class))

micdrop_target_exp <- data.frame(micdrop_target_exp$RNA, check.names = FALSE)
names(micdrop_target_exp) <- gsub("RNA.", "", names(micdrop_target_exp))

micdrop_target_scaled <- micdrop_target_exp %>% 
  rownames_to_column(var = "perturbation") %>% 
  pivot_longer(cols = -perturbation, names_to = "cell_type", values_to = "expression") %>%
  group_by(perturbation) %>%
  mutate(scaled_expression = range01(expression))
  
micdrop_target_scaled
```

Build lineage-perturbation dataframe
```{r}
## Split lineage_code into separate columns (LIN_1 through LIN_10)
## Each column represents one step in the lineage trajectory
lin_df <- meta %>% 
  distinct(curated_cell_type2, lineage_code) %>% 
  mutate(lineage_code = ifelse(substr(lineage_code, 1, 1) == "_", 
                               str_replace(lineage_code, "^_", ""), 
                               lineage_code)) %>%
  separate(lineage_code, 
           into = paste0("LIN_", 1:10), 
           sep = "_", 
           fill = "right")

## Create all combinations of cell types and perturbations
## This allows us to ask: for each perturbation, what is its expression in each cell type's lineage?
lin_pert_df <- map_dfr(unique(combined.meta$class), function(pert) {
  lin_df %>% mutate(perturbation = pert)
})

lin_pert_df <- lin_pert_df %>% 
  select(curated_cell_type2, perturbation, everything()) %>%
  filter(perturbation != "ND")

rownames(lin_pert_df) <- NULL
lin_pert_df
```

Find top-expressing lineage for each cell type / perturbation combination
```{r}
## Pivot to long format so each row is one cell_type / perturbation / lineage_step combo
## Then join with daniocell expression to get expression at each lineage step
lin_pert_df_long <- lin_pert_df %>% 
  pivot_longer(cols = -c(curated_cell_type2, perturbation)) %>% 
  select(-name) %>% 
  filter(!is.na(value)) %>% 
  dplyr::rename("lineage" = "value") %>% 
  left_join(dcell_target_scaled, by = c("perturbation", "lineage")) %>%
  filter(!is.na(expression))

## For each cell type / perturbation pair, keep only the lineage with highest expression
## This identifies where in the lineage the target gene is most expressed
lin_pert_df_long_top <- lin_pert_df_long %>%
  group_by(curated_cell_type2, perturbation) %>%
  slice_max(order_by = expression, n = 1) %>% 
  dplyr::rename(
    "top_lineage" = "lineage", 
    "top_scaled_expression" = "scaled_expression", 
    "top_expression" = "expression", 
    "cell_type" = "curated_cell_type2"
  )

lin_pert_df_long_top
```

# =============================================================================
# DEG ANALYSIS
# =============================================================================

Load and process DEG results
```{r}
DEG_results <- readRDS(file = "/Users/claytoncarey/Documents/Seurat/micdrop_seq/micdrop/Figure_code/MIC-Drop-seq/DEG_results_5_9_24.rds")
meta <- micdrop@meta.data



## Count significant DEGs per cell type / perturbation combination
## Filters: FDR < 0.05, |logFC| > 0.5, >10 perturbed cells, >800 cells in cluster
nDEG_df <- DEG_results %>%
  mutate(perturbation = factor(perturbation)) %>%
  filter(FDR < 0.05, ncell_perturbed > 10, cluster_ncell > 800, abs(logFC) > 0.5) %>%
  dplyr::count(cell_type, perturbation, .drop = FALSE) %>%
  dplyr::rename("nDEG" = "n") %>% 
  left_join(
    DEG_results %>% 
      select(cell_type, perturbation, cluster_ncell, ncell_perturbed) %>% 
      distinct(), 
    by = c("cell_type", "perturbation")
  )

```


Build autonomy classification dataframe
```{r}
## Combine MIC-Drop expression, top lineage expression, and DEG counts
## This dataframe contains all info needed to classify each perturbation effect
autonomy_df <- micdrop_target_scaled %>% 
  dplyr::rename("celltype_scaled_expression" = "scaled_expression") %>%
  left_join(lin_pert_df_long_top, by = c("cell_type", "perturbation")) %>%
  select(cell_type, perturbation, top_lineage, celltype_scaled_expression, top_scaled_expression) %>%
  ungroup() %>%
  left_join(nDEG_df, by = c("cell_type", "perturbation"))

autonomy_df
```

# =============================================================================
# AUTONOMY HEATMAP (Figure 4C)
# =============================================================================

```{r}
## Classification thresholds
## lin_thresh/cell_thresh: minimum scaled expression to consider gene "expressed"
## deg_thresh: minimum DEGs to consider a perturbation effect significant
lin_thresh <- 0.1
cell_thresh <- 0.1
deg_thresh <- 10
class_order <- c("Neural", "Mesoderm / Endoderm", "Non-neural Ectoderm")

## Order cell types by cluster size within each developmental class
ct_stats <- DEG_results %>% 
  filter(FDR < 0.05, abs(logFC) > 0.5, cluster_ncell > 800) %>%
  mutate(
    cell_type = factor(cell_type),
    cell_class = factor(cell_class, levels = class_order)
  ) %>%
  distinct(cluster_ncell, cell_type, cell_class) %>%
  group_by(cell_class) %>%
  arrange(desc(cluster_ncell)) %>% 
  arrange(cell_class)

## Count cell types per class (for row splitting in heatmap)
neu_len <- ct_stats %>% filter(cell_class == "Neural") %>% nrow()
meso_len <- ct_stats %>% filter(cell_class == "Mesoderm / Endoderm") %>% nrow()
ecto_len <- ct_stats %>% filter(cell_class == "Non-neural Ectoderm") %>% nrow()
ct_order <- ct_stats %>% pull(cell_type)

## Classify each cell type / perturbation combination:
## - cell autonomous: DEG effect + target expressed in that cell type
## - lineage autonomous: DEG effect + target expressed in precursor (not cell type itself)
## - non autonomous: DEG effect + target not expressed in lineage (indirect effect)
## - no effect: insufficient DEGs
autonomy_df_class <- autonomy_df %>%
  dplyr::filter(!is.na(nDEG)) %>% 
  mutate(autonomy = case_when(
    nDEG >= deg_thresh & celltype_scaled_expression > cell_thresh ~ "cell autonomous", 
    nDEG >= deg_thresh & celltype_scaled_expression < cell_thresh & top_scaled_expression > lin_thresh ~ "lineage autonomous", 
    nDEG >= deg_thresh & celltype_scaled_expression < cell_thresh & top_scaled_expression < lin_thresh ~ "non autonomous",
    nDEG < deg_thresh ~ "no effect",
    TRUE ~ "other"
  ))

## Convert to numeric codes for heatmap and reshape to matrix
autonomy_hm_df <- autonomy_df_class %>% 
  select(cell_type, perturbation, autonomy) %>% 
  mutate(autonomy_code = case_when(
    autonomy == "no effect" ~ 0,
    autonomy == "lineage autonomous" ~ 1,
    autonomy == "cell autonomous" ~ 2,
    autonomy == "non autonomous" ~ 3,
    TRUE ~ 0
  )) %>%
  select(-autonomy) %>% 
  pivot_wider(names_from = cell_type, values_from = autonomy_code) %>% 
  column_to_rownames(var = "perturbation") %>%
  select(all_of(ct_order)) %>% 
  t()

## Row annotation showing developmental compartment
ha <- rowAnnotation(
  foo = anno_block(
    gp = gpar(fill = c("#B2B8E0", "#FFCD82", "#85C989")), 
    labels = c("Neural", "Mesoderm + Endoderm", "NNE + NC")
  ), 
  width = unit(0.5, "cm")
)

## Factor for splitting rows by developmental class
split <- factor(
  c(rep("Neural", neu_len), 
    rep("Mesoderm / Endoderm", meso_len), 
    rep("Non-neural Ectoderm", ecto_len)),
  levels = c("Neural", "Mesoderm / Endoderm", "Non-neural Ectoderm")
)

## Build and save heatmap
hm <- Heatmap(
  autonomy_hm_df, 
  na_col = "darkgrey",  
  col = c("white", "#ACC2CFFF", "#678096FF", "#F4E7C5FF"), 
  column_names_rot = 45, 
  border = "lightgrey", 
  row_split = split, 
  right_annotation = NULL, 
  left_annotation = ha,
  row_gap = unit(4, "mm"),
  heatmap_legend_param = list(title = "Perturbation Type"), 
  rect_gp = gpar(col = "lightgrey"),  
  cluster_column_slices = FALSE, 
  show_column_dend = FALSE,
  cluster_rows = FALSE,
  show_row_dend = FALSE,
  row_dend_side = "right", 
  row_names_side = "left", 
  row_title = "                  ", 
  row_title_rot = 45
)

png(filename = "outputs_fig4/Figure_4C.png", height = 10, width = 13, units = "in", res = 300)
hm
dev.off()
```

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

Volcano plot function
```{r}
#' Generate volcano plot for a specific perturbation in a specific cell type

mk_volc <- function(result = DEG_results, pert, ct, pt = 0.05, lfc = 0.25, n_lab = 20) {
  
  filt_result <- result %>%
    filter(perturbation == pert, cell_type == ct)
  
  vp <- EnhancedVolcano(
    filt_result,
    title = paste0(ct), 
    subtitle = paste0(pert, " cells vs other cells"),
    lab = filt_result$gene, 
    x = "logFC", 
    y = "FDR", 
    labSize = 0, 
    FCcutoff = 0.5, 
    pCutoff = 0.05, 
    legendPosition = "none", 
    caption = NULL,  
    col = c("grey", "grey", "grey", "red"), 
    cutoffLineCol = "grey",  
    ylab = bquote(~"-" ~ Log[10] ~ "q value")
  ) +
    theme_classic() +
    NoLegend() +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title = element_text(size = 12),
      plot.title = element_text(size = 12),
      legend.text = element_text(size = 12),
      legend.title = element_blank()
    )
  
  ## Select top genes by FDR that pass thresholds, add repelled labels
  label_select <- filt_result %>% 
    filter(FDR < pt, abs(logFC) > lfc) %>% 
    top_n(wt = FDR, -n_lab)
  
  vp + geom_text_repel(
    data = label_select, 
    aes(x = logFC, y = -log10(FDR), label = gene), 
    force = 50, 
    nudge_x = 0, 
    nudge_y = 0.1, 
    max.overlaps = 40, 
    box.padding = 0.5, 
    size = 5
  )
}
```

UMAP plotting function
```{r}
## Precompute average expression per cell type for cluster labeling
expression <- AverageExpression(micdrop, 
                                 assays = "RNA", 
                                 features = unique(micdrop@meta.data$class), 
                                 group.by = "curated_cell_type2")
expression <- as.data.frame(t(expression$RNA)) %>%
  rownames_to_column(var = "cell_type")

#' Generate UMAP with gene expression overlay and cluster labels
#' @param gene Gene name to plot
#' @param thresh Expression threshold for labeling clusters
mk_umap <- function(gene, thresh = 0.2) {
  
  ## Get expression for this gene across cell types
  clust_exp <- expression %>% 
    dplyr::select(cell_type, all_of(gene)) %>% 
    arrange(desc(.data[[gene]]))
  
  print(clust_exp)
  
  ## Only label clusters with expression above threshold
  clust_lab <- clust_exp %>% 
    filter(!!sym(gene) > thresh) %>% 
    pull(cell_type)
  
  print(clust_lab)
  
  ## Add cluster labels to metadata (blank for low-expressing clusters)
  micdrop@meta.data <- micdrop@meta.data %>% 
    mutate(cluster_lab = ifelse(curated_cell_type2 %in% clust_lab, curated_cell_type2, " "))
  
  Idents(micdrop) <- "cluster_lab"
  
  FeaturePlot_scCustom(micdrop, features = gene, label = TRUE, reduction = 'umap') + NoAxes()
}
```

# =============================================================================
# EXAMPLE VOLCANO PLOTS
# =============================================================================

```{r}
mk_volc(pert = "tp63", ct = "Hemangioblasts")
mk_volc(pert = "tp63", ct = "Vasculature - Veins")
mk_volc(pert = "tp63", ct = "Vasculature - Arteries")
```



# =============================================================================
# AUTONOMY CLASSIFICATION ANALYSIS
# =============================================================================

Reclassify autonomy with updated naming scheme
```{r}
## Same classification logic but with publication-ready labels
exp_thresh <- 0.1
nDEG_thresh <- 10

autonomy_df_class <- autonomy_df %>%
  filter(!is.na(nDEG), cell_type %in% rownames(autonomy_hm_df)) %>%
  mutate(
    ## Classify based on DEG count and expression location
    autonomy = case_when(
      nDEG >= nDEG_thresh & celltype_scaled_expression > exp_thresh ~ "Cell-intrinsic", 
      nDEG >= nDEG_thresh & celltype_scaled_expression < exp_thresh & top_scaled_expression > exp_thresh ~ "Lineage-intrinsic", 
      nDEG >= nDEG_thresh & celltype_scaled_expression < exp_thresh & top_scaled_expression < exp_thresh ~ "Cell-extrinsic",
      nDEG < nDEG_thresh ~ "no effect",
      TRUE ~ "other"
    ),
    ## autonomy_possible: what class COULD this be based on expression alone (ignoring DEG count)
    autonomy_possible = case_when(
      celltype_scaled_expression > exp_thresh ~ "Cell-intrinsic",
      celltype_scaled_expression < exp_thresh & top_scaled_expression > exp_thresh ~ "Lineage-intrinsic",
      celltype_scaled_expression < exp_thresh & top_scaled_expression < exp_thresh ~ "Cell-extrinsic"
    ),
    ## Binary: does this combination have a significant perturbation effect?
    effect_type = ifelse(nDEG > nDEG_thresh, "perturbed", "unperturbed")
  ) %>%
  mutate(autonomy = factor(autonomy, levels = c("Cell-intrinsic", "Lineage-intrinsic", "Cell-extrinsic")))
```

# =============================================================================
# FIGURE PANELS
# =============================================================================

Figure S10B - DEG count distribution
```{r}
## Count DEGs per cell type / perturbation, including zeros
ndeg_df <- DEG_results %>% 
  mutate(cell_type = factor(cell_type), perturbation = factor(perturbation)) %>%
  filter(abs(logFC) > 0.5, FDR < 0.05) %>% 
  group_by(cell_type, perturbation) %>%
  summarize(n = n(), .groups = "drop") %>%
  complete(cell_type, perturbation, fill = list(n = 0)) %>%
  arrange(desc(n))

## Calculate quantiles to show distribution of effect sizes
quantiles <- quantile(ndeg_df$n, probs = c(0.5, 0.7, 0.8, 0.9, 0.95))

ggplot(ndeg_df, aes(x = n)) + 
  geom_histogram(binwidth = 1) + 
  geom_vline(xintercept = quantiles, linetype = "dashed", color = "darkgrey", linewidth = 0.5) +
  scale_x_continuous(limits = c(-1, 150), breaks = seq(0, 150, by = 10)) +
  theme_classic() + 
  theme(
    text = element_text(size = 12), 
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 12)
  ) +
  xlab("nDEG")

ggsave(filename = "outputs_fig4/Figure_S10B.eps", device = "eps",
       width = 6, height = 2, units = 'in', bg = "transparent")
```

Figure 4D - Autonomy proportions (stacked bar)
```{r}
## Count perturbation effects by autonomy class
autonomy_df_class %>% 
  filter(autonomy != "no effect", cluster_ncell > 800) %>%
  dplyr::count(autonomy) %>% 
  mutate(proportion = n / sum(n)) %>%
  ggplot(aes(x = "", y = proportion, fill = autonomy)) + 
  geom_bar(stat = "identity", width = 0.7, color = "black") +
  theme_classic() + 
  labs(y = "Percent", x = "Autonomy Type", fill = "Autonomy Type") + 
  coord_flip() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.y = element_blank()
  ) +
  geom_text(aes(label = paste0(autonomy, "\n", n)), 
            position = position_stack(vjust = 0.5),
            size = 2.5, 
            color = c("white", "white", "black")) +
  scale_fill_manual(values = c(  "#678096FF","#ACC2CFFF","#F4E7C5FF")) +  
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0)) +
  guides(fill = "none")

ggsave(filename = "outputs_fig4/Figure_4D.svg", device = "svg",
       width = 3, height = 1, units = 'in', dpi = "retina", bg = "transparent")

# Figure 4D - Phenotype Distribution (more compact)
# Figure 4D - Phenotype Distribution (pie chart with better labels)
plot_data <- autonomy_df_class %>% 
  filter(autonomy != "no effect", cluster_ncell > 800) %>%
  dplyr::count(autonomy) %>% 
  mutate(
    proportion = n / sum(n),
    # Calculate cumulative sum for positioning
    csum = rev(cumsum(rev(proportion))),
    # Position in the middle of each slice
    ypos = proportion/2 + lead(csum, 1),
    ypos = if_else(is.na(ypos), proportion/2, ypos)
  )

ggplot(plot_data, aes(x = "", y = proportion, fill = autonomy)) + 
  geom_bar(stat = "identity", width = 1, color = "black") +
  coord_polar("y", start = 0) +
  theme_void() +
  theme(
    plot.title = element_text(size = 10, hjust = 0.5, margin = margin(b = 10)),
    plot.margin = unit(c(0.2, 0.2, 0.2, 0.2), "cm")
  ) +
  geom_text(aes(y = ypos, label = paste0(autonomy, "\n", n, "\n(", 
                                          scales::percent(proportion, accuracy = 1), ")")), 
            size = 2.9,
            color = c("white", "black", "black")) +
  scale_fill_manual(values = c("#678096FF","#ACC2CFFF","#F4E7C5FF")) +
  guides(fill = "none")


ggsave(filename = "outputs_fig4/Figure_4D.svg", device = "svg",
       width = 2.5, height = 2.5, units = 'in', dpi = "retina", bg = "transparent")
```


```{r}

library(ggplot2)
library(dplyr)
library(patchwork)
pct_perturbed <- autonomy_df_class %>% 
  filter(cluster_ncell > 800) %>%
  dplyr::count(autonomy_possible, effect_type) %>% 
  group_by(autonomy_possible) %>% 
  mutate(total = sum(n)) %>% 
  ungroup() %>%
  mutate(pct = n / total) %>% 
  filter(effect_type == "perturbed")

# --- Plot 1 (Top: Figure 4E) ---
p1 <- pct_perturbed %>% 
  mutate(autonomy_possible = factor(autonomy_possible, 
                                    levels = c("Cell-extrinsic", "Lineage-intrinsic", "Cell-intrinsic"))) %>% 
  ggplot(aes(x = autonomy_possible, y = pct)) + 
  geom_bar(stat = 'identity', color = "black") + # Added fill for visibility
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0), limits = c(0, 0.25)) +
  labs(y = "Effect Freq.", x = "Target Expression", title = "") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8, vjust = 1),
    axis.text.y = element_text(size = 9),
    axis.title.y = element_text(size = 10),
    axis.title.x = element_text(size = 10, margin = margin(t = 5)),
    # Top margin set to 0 to sit tight against the upper plot
    plot.margin = unit(c(0, 0.1, 0.1, 0.1), "cm") 
  ) +
  scale_x_discrete(labels = c("Cell-extrinsic" = "Not expressed",
                              "Lineage-intrinsic" = "Lineage", 
                              "Cell-intrinsic" = "Cell Type"))
  

# --- Plot 2 (Bottom: Figure 4F) ---
p2 <- autonomy_df_class %>%
  filter(cluster_ncell > 800) %>%
  mutate(autonomy_possible = factor(autonomy_possible, 
                                    levels = c("Cell-extrinsic", "Lineage-intrinsic", "Cell-intrinsic"))) %>%
  group_by(autonomy_possible) %>% 
  summarize(meanNDEG = mean(nDEG)) %>%
  ggplot(aes(x = autonomy_possible, y = meanNDEG)) + 
  geom_bar(stat = 'identity', color = "black") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 15)) +
  labs(y = "Mean #DEG", x = NULL, title = "")+
  theme_classic() + 
  theme(
    # Remove x-axis text/ticks so it sits flush on top of the next plot
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(), # Optional: removes the black line if you want seamless look
    axis.text.y = element_text(size = 9),
    axis.title.y = element_text(size = 10),
    # Bottom margin set to -5pt to pull the next plot up tight
    plot.margin = unit(c(0.2, 0.1, -0.2, 0.1), "cm") 
  )

# --- Combine ---
# The negative margin in p1 combined with 0 margin in p2 makes them touch.
combined_plot <- p2 / p1

combined_plot

ggsave(filename = "outputs_fig4/Figure_4EF_Stacked.eps", plot = combined_plot,
       device = "eps", width = 2, height = 3, units = 'in', dpi = "retina", bg = "transparent")
```

Figure S10C/D - Threshold sensitivity analysis
```{r}
## Test how classification changes across different DEG thresholds
## Demonstrates robustness of relative proportions to threshold choice
mut_distribution <- map_dfr(c(10, 25, 50, 75, 100, 125, 150, 175, 200), function(i) {
  
  exp_thresh <- 0.1
  nDEG_thresh <- i
  
  autonomy_df %>%
    filter(!is.na(nDEG), cell_type %in% rownames(autonomy_hm_df)) %>%
    mutate(
      autonomy = case_when(
        nDEG >= nDEG_thresh & celltype_scaled_expression > exp_thresh ~ "Cell-intrinsic", 
        nDEG >= nDEG_thresh & celltype_scaled_expression < exp_thresh & top_scaled_expression > exp_thresh ~ "Lineage-intrinsic", 
        nDEG >= nDEG_thresh & celltype_scaled_expression < exp_thresh & top_scaled_expression < exp_thresh ~ "Cell-extrinsic",
        nDEG < nDEG_thresh ~ "no effect",
        TRUE ~ "other"
      )
    ) %>%
    mutate(autonomy = factor(autonomy, levels = c("Cell-intrinsic", "Lineage-intrinsic", "Cell-extrinsic"))) %>%
    filter(autonomy != "no effect") %>% 
    dplyr::count(autonomy) %>% 
    mutate(proportion = n / sum(n), deg_thresh = nDEG_thresh)
})

## S10C: Proportions remain relatively stable across thresholds
ggplot(mut_distribution, aes(x = deg_thresh, y = proportion, color = autonomy)) +
  geom_line(size = 1.5) +
  geom_point() +
  scale_color_manual(values = c("#678096FF", "#ACC2CFFF", "#F4E7C5FF"), name = "Phenotype Class") + 
  theme_classic(base_size = 12) +
  xlab("DEG Threshold") + 
  ylab("Phenotype Proportions")

ggsave(filename = "outputs_fig4/FigureS10C.eps", device = "eps",
       width = 6, height = 4, units = 'in', dpi = "retina", bg = "transparent")

## S10D: Absolute counts decrease with stricter thresholds
ggplot(mut_distribution, aes(x = deg_thresh, y = n, color = autonomy)) +
  geom_line(size = 1.5) +
  geom_point() +
  scale_color_manual(values = c("#678096FF", "#ACC2CFFF", "#F4E7C5FF"), name = "Phenotype Class") + 
  theme_classic(base_size = 12) +
  xlab("DEG Threshold") + 
  ylab("Phenotypes Detected")

ggsave(filename = "outputs_fig4/FigureS10D.eps", device = "eps",
       width = 6, height = 4, units = 'in', dpi = "retina", bg = "transparent")
```

# =============================================================================
# VASCULAR VALIDATION PLOTS
# =============================================================================

Common theme for boxplots
```{r}
## Consistent styling for all validation boxplots
theme_boxplot <- theme_classic() +
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1), 
    axis.text.y = element_text(size = 10), 
    axis.title.x = element_text(size = 10), 
    axis.title.y = element_text(size = 10),
    axis.line = element_line(size = 0.2)
  )

## Italicize gene names in x-axis labels
tp63_labels <- c("scramble" = "control", "tp63" = expression(italic("tp63")))
```



```{r}

vasc_measure <- read.csv(file = "input_data/tp63_rescue_measure.csv")


#sample table
print("Sample Table - isv with flow - n embryos")
print(table(vasc_measure$injection))

 #One-way ANOVA
vasc_anova <- vasc_measure %>%
  anova_test( cvp_width ~ injection)

print(vasc_anova)

#Post-hoc Tukey HSD (all pairwise comparisons)
vasc_tukey <- vasc_measure %>%
  tukey_hsd(cvp_width ~ injection) %>%
  add_xy_position(x = "injection", step.increase = 0.1)

print(vasc_tukey)

# Optional: Filter if you ONLY want specific pairs (e.g., exclude control vs rescue)
vasc_tukey <- vasc_tukey[c(1,3),]


# Define labels
tp63_labels_resc <- expression(
  "control", 
  italic("tp63"), 
  paste(italic("tp63"), " + mRNA")
)

# Plot
ggplot(vasc_measure, aes(x = injection, y = cvp_width)) +
  geom_boxplot(fill = "lightgrey", size = 0.2, outlier.shape = NA) +
  geom_jitter(width = 0.2, size = 0.3, color = "black") +
  theme_boxplot +
  stat_pvalue_manual(vasc_tukey, label = "p.adj.signif", tip.length = 0.05, 
                     hide.ns = FALSE, step.increase = .1, bracket.nudge.y = 10) +
  scale_x_discrete(labels = tp63_labels_resc) + 
  labs(y = bquote(CVP ~ width ~ "(" * mu * "m)"), x = "") +  
  theme(axis.title.x = element_blank()) +
  ylim(0, 150)

ggsave(filename = "outputs_fig4/Figure4H.eps", device = "eps",
       width = 1.5, height = 2.5, units = 'in', dpi = "retina", bg = "transparent")
```





```{r}
isv <- read.csv(file = "/Users/claytoncarey/Downloads/flowj_tp63_rescue.csv", check.names = FALSE) %>% 
  pivot_longer(cols = everything(), names_to = "condition", values_to = "n_isv")

#sample table
print("Sample Table - isv with flow - n embryos")
print(table(isv$condition))

 #One-way ANOVA
isv_anova <- isv %>%
  anova_test(n_isv ~ condition)

print(isv_anova)

#Post-hoc Tukey HSD (all pairwise comparisons)
isv_tukey <- isv %>%
  tukey_hsd(n_isv ~ condition) %>%
  add_xy_position(x = "condition", step.increase = 0.1)

print(isv_tukey)

# Optional: Filter if you ONLY want specific pairs (e.g., exclude control vs rescue)
isv_tukey <- isv_tukey[c(1,3),]


isv %>%  ggplot(aes(x = condition, y = n_isv)) +
  geom_boxplot(fill = "lightgrey", size = 0.2, outliers = FALSE) + 
  scale_x_discrete(labels = tp63_labels_resc) +
  geom_jitter(width = 0.1, size = 0.2, color = "black") + 
  theme_boxplot +
  stat_pvalue_manual(isv_tukey, label = "p.adj.signif", tip.length = 0.05,step.increase = -.05, bracket.nudge.y = 1 , 
                     hide.ns = FALSE) +
  scale_x_discrete(labels = tp63_labels_resc) + 
  labs(x = "", y = "# ISV with flow") +
  theme(axis.title.x = element_blank()) +
  ylim(0, 22)
  
ggsave(filename = "outputs_fig4/Figure4I.eps", device = "eps",
       width = 1.5, height = 2.5, units = 'in', dpi = "retina", bg = "transparent")
```


# =============================================================================
# SUPPLEMENTARY FIGURES - tp63 VALIDATION
# =============================================================================

Figure S11A - Cell cluster proportions
```{r}

meta <- micdrop@meta.data

## Calculate proportion of cells in each cluster per perturbation/replicate
counts <- meta %>% 
  group_by(class, group) %>% 
  dplyr::count(curated_cell_type2) %>%
  mutate(
    total_perturb = sum(n),
    pct_cluster = n / total_perturb
  )

## Compare vein cluster proportion in tp63 vs all other perturbations
counts %>% 
  filter(curated_cell_type2 == "Vasculature - Veins") %>%
  mutate(class = ifelse(class %in% c("tp63"), class, "other")) %>%
  mutate(class = factor(class, levels = c("other", "tp63"))) %>%
  ggplot(aes(x = class, y = pct_cluster * 100)) +
  geom_boxplot(fill = 'grey', outliers = FALSE, size = 0.2) + 
  ylim(c(0, 2)) +
  theme_boxplot +
  labs(y = "% cells in cluster", x = "Mutation") +
  scale_x_discrete(labels = c("other" = "other", "tp63" = expression(italic("tp63"))))

ggsave(filename = "outputs_fig4/FigureS11A.eps", device = "eps",
       width = 1.5, height = 3, units = 'in', dpi = "retina", bg = "transparent")

```

Figure S11B - tp63 volcano plots
```{r}

mk_volc(pert = "tp63", ct = "Vasculature - Veins")
ggsave(filename = "outputs_fig4/FigureS11B-1.png", device = "png",
       width = 6, height = 6, units = 'in', dpi = "retina", bg = "transparent")

mk_volc(pert = "tp63", ct = "Vasculature - Arteries")
ggsave(filename = "outputs_fig4/FigureS11B-2.png", device = "png",
       width = 6, height = 6, units = 'in', dpi = "retina", bg = "transparent")

mk_volc(pert = "tp63", ct = "Hemangioblasts")
ggsave(filename = "outputs_fig4/FigureS11B-3.png", device = "png",
       width = 6, height = 6, units = 'in', dpi = "retina", bg = "transparent")

```

Figure S11C - tp63 UMAP
```{r}

DefaultAssay(micdrop) <- "RNA"
mk_umap("tp63")
ggsave(filename = "outputs_fig4/FigureS11C.png", device = "png",
       width = 8, height = 8, units = 'in', dpi = "retina", bg = "transparent")

```

Figure S11D - ISV width
```{r}
isv_len <- read.csv(file = "input_data/tp63_vascular_measurements_2nd_somite.csv")

isv_len_wide <- isv_len %>%
  # 1. Select only what you need
  select(injection, ISV.width) %>%
  # 2. Create a unique ID for each observation within each group
  group_by(injection) %>%
  mutate(row_id = row_number()) %>% 
  ungroup() %>%
  # 3. Pivot wider using the new row_id to keep measurements separate
  pivot_wider(names_from = injection, values_from = ISV.width) %>%
  # 4. (Optional) Remove the row_id column
  select(-row_id)

t.test(isv_len_wide$scramble, isv_len_wide$tp63 )

ggplot(isv_len, aes(x = injection, y = ISV.width)) +
  geom_boxplot(fill = "lightgrey", size = 0.2, outliers = FALSE) + 
  geom_jitter(width = 0.1, size = 0.2, color = "black") + 
  theme_boxplot +
  labs(x = "Injection", y = bquote(ISV ~ length ~ "(" * mu * "m)")) +
  scale_x_discrete(labels = tp63_labels) +
  stat_compare_means(
    comparisons = list(c("scramble", "tp63")), 
    method = "t.test", 
    label = "p.signif",
    symnum.args = list(cutpoints = c(0, 0.005, 0.0005, 1), symbols = c("*", "**", "ns"))
  ) + 
  ylim(0, 150)

ggsave(filename = "outputs_fig4/FigureS11D.eps", device = "eps",
       width = 1.5, height = 3, units = 'in', dpi = "retina", bg = "transparent")

```

Figure S11H - Heart rate (BPM)
```{r}

bpm <- read.csv(file = "input_data/bpm.csv")

t.test(bpm$scramble, bpm$tp63)

bpm %>% 
  pivot_longer(cols = everything()) %>% 
  dplyr::rename("injection" = "name", "flow" = "value") %>% 
  ggplot(aes(x = injection, y = flow)) +
  geom_boxplot(fill = "lightgrey", size = 0.2, outliers = FALSE) + 
  geom_jitter(width = 0.1, size = 0.2, color = "black") + 
  theme_boxplot +
  labs(x = "Injection", y = "BPM") +
  scale_x_discrete(labels = tp63_labels) +
  stat_compare_means(
    comparisons = list(c("scramble", "tp63")), 
    method = "t.test", 
    method.args = "two.sided",
    label = "p.signif",
    symnum.args = list(cutpoints = c(0, 0.05, 0.0005, 1), symbols = c("*", "**", "ns"))
  ) + 
  ylim(0, 110)

ggsave(filename = "outputs_fig4/FigureS11g.eps", device = "eps",
       width = 1.5, height = 3, units = 'in', dpi = "retina", bg = "transparent")

```



